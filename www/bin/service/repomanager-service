#!/usr/bin/env bash
set -u
trap 'kill 0' EXIT

# Leave a delay of 30sec to let the system start
sleep 30

SCRIPT_PATH=$(realpath $0)
DATA_DIR="/var/lib/repomanager"
DB="$DATA_DIR/db/repomanager.db"

WWW_DIR=""
WWW_USER=""

# Get additionnal variables
function getVars
{
    # Check is database exists
    while [ ! -f "$DB" ]; do
        echo "Error: Database '$DB' not found."
        sleep 2
    done

    RETRY=0
    while [ -z "$WWW_DIR" ]; do
        if [ $RETRY -gt 3 ];then
            echo "Error: WWW_DIR not found in database."
            exit 1
        fi

        WWW_DIR=$(/usr/bin/sqlite3 -noheader -batch -cmd '.timeout 10000' "$DB" "SELECT WWW_DIR FROM settings" | sed 's/ //g')

        (( RETRY++ ))
        sleep 2
    done

    RETRY=0
    while [ -z "$WWW_USER" ]; do
        if [ $RETRY -gt 3 ];then
            echo "Error: WWW_USER not found in database."
            exit 1
        fi

        WWW_USER=$(/usr/bin/sqlite3 -noheader -batch -cmd '.timeout 10000' "$DB" "SELECT WWW_USER FROM settings" | sed 's/ //g')
        
        sleep 2
        (( RETRY++ ))
    done
}

function generalChecks
{
    # Check if www user is defined
    if [ -z "$WWW_USER" ];then
        echo "Error: www user is not defined."
        exit 1
    fi
}

getVars

generalChecks

/bin/su -s /bin/sh -c "/usr/bin/php $WWW_DIR/tools/service.php" "$WWW_USER"

exit